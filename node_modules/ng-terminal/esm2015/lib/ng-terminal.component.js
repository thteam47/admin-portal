/**
 * @fileoverview added by tsickle
 * Generated from: lib/ng-terminal.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, ViewChild, ElementRef, Input, Output, EventEmitter } from '@angular/core';
import { Terminal } from 'xterm';
import { FitAddon } from 'xterm-addon-fit';
import { Subject, combineLatest } from 'rxjs';
export class NgTerminalComponent {
    constructor() {
        this.keyInputSubject = new Subject();
        this.keyEventSubject = new Subject();
        this.termSnippetSubject = new Subject();
        this.afterViewInitSubject = new Subject();
        this.h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
        this.displayOption = {};
        this.terminalStyle = {};
        this.keyInputEmitter = new EventEmitter();
        this.keyEventEmitter = new EventEmitter();
        this.termSnippetSubscription = combineLatest(this.termSnippetSubject, this.afterViewInitSubject).subscribe((/**
         * @param {?} __0
         * @return {?}
         */
        ([snippet]) => {
            snippet();
        }));
    }
    /**
     * @param {?} ds
     * @return {?}
     */
    set _dataSource(ds) {
        if (this.dataSourceSubscription != null) {
            this.dataSourceSubscription.unsubscribe();
        }
        this.dataSource = ds;
        this.dataSourceSubscription = this.dataSource.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            this.write(data);
        }));
    }
    /**
     * @return {?}
     */
    get _dataSource() {
        return this.dataSource;
    }
    /**
     * @param {?} opt
     * @return {?}
     */
    set _displayOption(opt) {
        this.setDisplayOption(opt);
    }
    /**
     * @param {?} opt
     * @return {?}
     */
    set _style(opt) {
        this.setStyle(opt);
    }
    /**
     * @private
     * @return {?}
     */
    observableSetup() {
        this.term.onData((/**
         * @param {?} input
         * @return {?}
         */
        (input) => {
            this.keyInputSubject.next(input);
        }));
        this.term.onKey((/**
         * @param {?} e
         * @return {?}
         */
        e => {
            this.keyEventSubject.next(e);
        }));
        this.keyInputSubjectSubscription = this.keyInputSubject.subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            this.keyInputEmitter.emit(data);
        }));
        this.keyEventSubjectSubscription = this.keyEventSubject.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this.keyEventEmitter.emit(e);
        }));
        this.afterViewInitSubject.next();
    }
    /**
     * set block or inline-block to #terminal for fitting client or outer element
     * @private
     * @param {?} isBlock
     * @return {?}
     */
    setTerminalBlock(isBlock) {
        if (isBlock)
            this.terminalStyle['display'] = 'block';
        else
            this.terminalStyle['display'] = 'inline-block';
    }
    /**
     * set dimensions
     * @private
     * @param {?} left
     * @param {?} top
     * @param {?} width
     * @param {?} height
     * @return {?}
     */
    setTerminalDimensions(left, top, width, height) {
        this.terminalStyle['left'] = left ? `${left}px` : undefined;
        this.terminalStyle['top'] = top ? `${top}px` : undefined;
        this.terminalStyle['width'] = width ? `${width}px` : undefined;
        this.terminalStyle['height'] = height ? `${height}px` : undefined;
    }
    /**
     * remove dimensions
     * @private
     * @return {?}
     */
    removeTerminalDimensions() {
        this.terminalStyle['left'] = undefined;
        this.terminalStyle['top'] = undefined;
        this.terminalStyle['width'] = undefined;
        this.terminalStyle['height'] = undefined;
    }
    /**
     * @param {?} styleObject
     * @return {?}
     */
    setStyle(styleObject) {
        Object.assign(this.terminalStyle, styleObject);
    }
    /**
     * @return {?}
     */
    ngOnInit() {
    }
    /**
     * When a dimension of div changes, fit a terminal in div.
     * @return {?}
     */
    ngAfterViewChecked() {
        /** @type {?} */
        let dims = this.fitAddon.proposeDimensions();
        if (dims === undefined || isNaN(dims.rows) || dims.rows == Infinity || isNaN(dims.cols) || dims.cols == Infinity) {
            this.term.resize(10, 10);
        }
        else if (!this.displayOption.fixedGrid) {
            this.fitAddon.fit();
        }
        else {
            this.term.resize(this.displayOption.fixedGrid.cols, this.displayOption.fixedGrid.rows);
            /** @type {?} */
            let xtermScreen = this.term.element.getElementsByClassName('xterm-screen')[0];
            /** @type {?} */
            let scrollArea = this.term.element.getElementsByClassName('xterm-scroll-area')[0];
            /** @type {?} */
            let terminal = this.term.element;
            /** @type {?} */
            const contentWidth = xtermScreen.clientWidth;
            /** @type {?} */
            const scrollWidth = terminal.clientWidth - scrollArea.clientWidth;
            this.setTerminalDimensions(undefined, undefined, contentWidth + scrollWidth, undefined);
        }
    }
    /**
     * It creates new terminal in #terminal.
     * @return {?}
     */
    ngAfterViewInit() {
        this.fitAddon = new FitAddon();
        this.term = new Terminal();
        this.term.open(this.terminalDiv.nativeElement);
        this.term.loadAddon(this.fitAddon);
        this.observableSetup();
    }
    /**
     * clean all resources
     * @return {?}
     */
    ngOnDestroy() {
        if (this.keyInputSubjectSubscription)
            this.keyInputSubjectSubscription.unsubscribe();
        if (this.dataSourceSubscription)
            this.dataSourceSubscription.unsubscribe();
        if (this.keyEventSubjectSubscription)
            this.keyEventSubjectSubscription.unsubscribe();
        if (this.termSnippetSubscription)
            this.termSnippetSubscription.unsubscribe();
        if (this.term)
            this.term.dispose();
    }
    /**
     * @param {?} chars
     * @return {?}
     */
    write(chars) {
        this.term.write(chars);
    }
    /**
     * @param {?} opt
     * @return {?}
     */
    setDisplayOption(opt) {
        if (opt) {
            if (opt.fixedGrid != null) {
                console.debug("resizable will be ignored.");
                this.setTerminalBlock(false);
                this.removeTerminalDimensions();
            }
            else {
                this.setTerminalBlock(true);
            }
            this.displayOption = opt;
        }
        else
            console.warn(`A falsy option is not allowed`);
    }
    /**
     * @return {?}
     */
    get keyInput() {
        return this.keyInputSubject;
    }
    /**
     * @return {?}
     */
    get keyEventInput() {
        return this.keyEventSubject;
    }
    /**
     * @return {?}
     */
    get underlying() {
        return this.term;
    }
    /**
     * @return {?}
     */
    get isDraggableOnEdgeActivated() {
        return this.displayOption.activateDraggableOnEdge != undefined && this.displayOption.fixedGrid == undefined;
    }
    /**
     * After user coordinate dimensions of terminal, it's called.
     * @param {?} left
     * @param {?} top
     * @param {?} width
     * @param {?} height
     * @return {?}
     */
    onResizeEnd(left, top, width, height) {
        this.setTerminalDimensions(left, top, width, height);
    }
    /**
     * Before onResizeEnd is called, it valiates dimensions to change.
     * @return {?}
     */
    validatorFactory() {
        /** @type {?} */
        const comp = this;
        return (/**
         * @param {?} re
         * @return {?}
         */
        (re) => {
            /** @type {?} */
            const displayOption = comp.displayOption;
            if (displayOption.activateDraggableOnEdge) {
                /** @type {?} */
                let left = re.rectangle.left;
                /** @type {?} */
                let top = re.rectangle.top;
                /** @type {?} */
                let width = re.rectangle.width;
                /** @type {?} */
                let height = re.rectangle.height;
                if ((width < displayOption.activateDraggableOnEdge.minWidth) || (height < displayOption.activateDraggableOnEdge.minHeight)) {
                    return false;
                }
                else
                    return true;
            }
        });
    }
}
NgTerminalComponent.decorators = [
    { type: Component, args: [{
                selector: 'ng-terminal',
                template: "<global-style></global-style>\r\n\r\n<div #terminal class=\"terminal-outer\" mwlResizable [ngStyle]=\"terminalStyle\" [validateResize]=\"validatorFactory()\" [enableGhostResize]=\"true\" [resizeEdges]=\"isDraggableOnEdgeActivated ? {bottom: true, right: true} : {bottom: false, right: false}\"\r\n(resizeEnd)=\"onResizeEnd($event.rectangle.left, $event.rectangle.top, $event.rectangle.width, $event.rectangle.height)\">\r\n</div>",
                styles: [".terminal-outer{box-sizing:border-box;height:100%}"]
            }] }
];
/** @nocollapse */
NgTerminalComponent.ctorParameters = () => [];
NgTerminalComponent.propDecorators = {
    _dataSource: [{ type: Input, args: ['dataSource',] }],
    _displayOption: [{ type: Input, args: ['displayOption',] }],
    _style: [{ type: Input, args: ['style',] }],
    keyInputEmitter: [{ type: Output, args: ['keyInput',] }],
    keyEventEmitter: [{ type: Output, args: ['keyEvent',] }],
    terminalDiv: [{ type: ViewChild, args: ['terminal', { static: true },] }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.term;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.fitAddon;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.keyInputSubject;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.keyEventSubject;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.termSnippetSubject;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.afterViewInitSubject;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.keyInputSubjectSubscription;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.keyEventSubjectSubscription;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.termSnippetSubscription;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.h;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.displayOption;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.dataSource;
    /**
     * @type {?}
     * @private
     */
    NgTerminalComponent.prototype.dataSourceSubscription;
    /** @type {?} */
    NgTerminalComponent.prototype.terminalStyle;
    /** @type {?} */
    NgTerminalComponent.prototype.keyInputEmitter;
    /** @type {?} */
    NgTerminalComponent.prototype.keyEventEmitter;
    /** @type {?} */
    NgTerminalComponent.prototype.terminalDiv;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctdGVybWluYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctdGVybWluYWwvIiwic291cmNlcyI6WyJsaWIvbmctdGVybWluYWwuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBNEIsU0FBUyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBNEIsTUFBTSxlQUFlLENBQUM7QUFDbEosT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUNqQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFM0MsT0FBTyxFQUFFLE9BQU8sRUFBNEIsYUFBYSxFQUEyQixNQUFNLE1BQU0sQ0FBQztBQVNqRyxNQUFNLE9BQU8sbUJBQW1CO0lBa0Q5QjtRQS9DUSxvQkFBZSxHQUFvQixJQUFJLE9BQU8sRUFBVSxDQUFDO1FBQ3pELG9CQUFlLEdBQUcsSUFBSSxPQUFPLEVBQTJDLENBQUM7UUFDekUsdUJBQWtCLEdBQUcsSUFBSSxPQUFPLEVBQVksQ0FBQztRQUM3Qyx5QkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBSzNDLE1BQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxXQUFXLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDN0Usa0JBQWEsR0FBa0IsRUFBRSxDQUFDO1FBRzFDLGtCQUFhLEdBQVcsRUFBRSxDQUFDO1FBMkIzQixvQkFBZSxHQUFJLElBQUksWUFBWSxFQUFVLENBQUM7UUFHOUMsb0JBQWUsR0FBSSxJQUFJLFlBQVksRUFBMkMsQ0FBQztRQU03RSxJQUFJLENBQUMsdUJBQXVCLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxTQUFTOzs7O1FBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUU7WUFDdkgsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDLEVBQUMsQ0FBQztJQUNMLENBQUM7Ozs7O0lBckNELElBQ0ksV0FBVyxDQUFDLEVBQUU7UUFDaEIsSUFBRyxJQUFJLENBQUMsc0JBQXNCLElBQUksSUFBSSxFQUFDO1lBQ3JDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUMzQztRQUNELElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVM7Ozs7UUFBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQy9ELElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkIsQ0FBQyxFQUFDLENBQUE7SUFDSixDQUFDOzs7O0lBQ0QsSUFBSSxXQUFXO1FBQ2IsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQ3pCLENBQUM7Ozs7O0lBRUQsSUFDSSxjQUFjLENBQUMsR0FBa0I7UUFDbkMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzdCLENBQUM7Ozs7O0lBRUQsSUFDSSxNQUFNLENBQUMsR0FBUTtRQUNqQixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3JCLENBQUM7Ozs7O0lBaUJPLGVBQWU7UUFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNOzs7O1FBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUN6QixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuQyxDQUFDLEVBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSzs7OztRQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ2xCLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9CLENBQUMsRUFBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLDJCQUEyQixHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsU0FBUzs7OztRQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDekUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEMsQ0FBQyxFQUFDLENBQUE7UUFDRixJQUFJLENBQUMsMkJBQTJCLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTOzs7O1FBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtZQUN0RSxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvQixDQUFDLEVBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNuQyxDQUFDOzs7Ozs7O0lBS08sZ0JBQWdCLENBQUMsT0FBZ0I7UUFDdkMsSUFBRyxPQUFPO1lBQ1IsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsR0FBRyxPQUFPLENBQUM7O1lBRXhDLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLEdBQUcsY0FBYyxDQUFDO0lBQ25ELENBQUM7Ozs7Ozs7Ozs7SUFLTyxxQkFBcUIsQ0FBQyxJQUFZLEVBQUUsR0FBVyxFQUFFLEtBQWEsRUFBRSxNQUFjO1FBQ3BGLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDNUQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUN6RCxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQy9ELElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7SUFDcEUsQ0FBQzs7Ozs7O0lBS08sd0JBQXdCO1FBQzlCLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLEdBQUcsU0FBUyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLEdBQUcsU0FBUyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsU0FBUyxDQUFDO1FBQ3hDLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLEdBQUcsU0FBUyxDQUFDO0lBQzNDLENBQUM7Ozs7O0lBRUQsUUFBUSxDQUFDLFdBQWdCO1FBQ3ZCLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNqRCxDQUFDOzs7O0lBRUQsUUFBUTtJQUNSLENBQUM7Ozs7O0lBS0Qsa0JBQWtCOztZQUNaLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGlCQUFpQixFQUFFO1FBQzVDLElBQUcsSUFBSSxLQUFLLFNBQVMsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksUUFBUSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksSUFBSSxRQUFRLEVBQUM7WUFDOUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQzFCO2FBQUssSUFBRyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFDO1lBQ3JDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUM7U0FDckI7YUFBSTtZQUNILElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQzs7Z0JBQ25GLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUM7O2dCQUN6RSxVQUFVLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsc0JBQXNCLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDLENBQUM7O2dCQUM3RSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPOztrQkFDMUIsWUFBWSxHQUFHLFdBQVcsQ0FBQyxXQUFXOztrQkFDdEMsV0FBVyxHQUFHLFFBQVEsQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFDLFdBQVc7WUFDakUsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUUsWUFBWSxHQUFHLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQztTQUN6RjtJQUNILENBQUM7Ozs7O0lBS0QsZUFBZTtRQUNiLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksUUFBUSxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUMvQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQ3pCLENBQUM7Ozs7O0lBS0QsV0FBVztRQUNULElBQUcsSUFBSSxDQUFDLDJCQUEyQjtZQUNqQyxJQUFJLENBQUMsMkJBQTJCLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDakQsSUFBRyxJQUFJLENBQUMsc0JBQXNCO1lBQzVCLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUM1QyxJQUFHLElBQUksQ0FBQywyQkFBMkI7WUFDakMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ2pELElBQUcsSUFBSSxDQUFDLHVCQUF1QjtZQUMvQixJQUFJLENBQUMsdUJBQXVCLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDM0MsSUFBRyxJQUFJLENBQUMsSUFBSTtZQUNWLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDeEIsQ0FBQzs7Ozs7SUFFRCxLQUFLLENBQUMsS0FBYTtRQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN6QixDQUFDOzs7OztJQUVELGdCQUFnQixDQUFDLEdBQWtCO1FBQ2pDLElBQUksR0FBRyxFQUFFO1lBQ1AsSUFBSSxHQUFHLENBQUMsU0FBUyxJQUFJLElBQUksRUFBRTtnQkFDekIsT0FBTyxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO2dCQUM1QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQzdCLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO2FBQ2pDO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUM3QjtZQUNELElBQUksQ0FBQyxhQUFhLEdBQUcsR0FBRyxDQUFDO1NBQzFCOztZQUNDLE9BQU8sQ0FBQyxJQUFJLENBQUMsK0JBQStCLENBQUMsQ0FBQztJQUNsRCxDQUFDOzs7O0lBRUQsSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDO0lBQzlCLENBQUM7Ozs7SUFFRCxJQUFJLGFBQWE7UUFDZixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUM7SUFDOUIsQ0FBQzs7OztJQUVELElBQUksVUFBVTtRQUNaLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNuQixDQUFDOzs7O0lBRUQsSUFBSSwwQkFBMEI7UUFDNUIsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLHVCQUF1QixJQUFJLFNBQVMsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsSUFBSSxTQUFTLENBQUM7SUFDOUcsQ0FBQzs7Ozs7Ozs7O0lBU0QsV0FBVyxDQUFDLElBQVksRUFBRSxHQUFXLEVBQUUsS0FBYSxFQUFFLE1BQWM7UUFDbEUsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3ZELENBQUM7Ozs7O0lBTUQsZ0JBQWdCOztjQUNSLElBQUksR0FBRyxJQUFJO1FBQ2pCOzs7O1FBQU8sQ0FBQyxFQUFlLEVBQUUsRUFBRTs7a0JBQ25CLGFBQWEsR0FBRyxJQUFJLENBQUMsYUFBYTtZQUN4QyxJQUFHLGFBQWEsQ0FBQyx1QkFBdUIsRUFBQzs7b0JBQ25DLElBQUksR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUk7O29CQUFFLEdBQUcsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUc7O29CQUFFLEtBQUssR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLEtBQUs7O29CQUFFLE1BQU0sR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLE1BQU07Z0JBQzlHLElBQUksQ0FBQyxLQUFLLEdBQUcsYUFBYSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQyxTQUFTLENBQUMsRUFBRTtvQkFDMUgsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7O29CQUFNLE9BQU8sSUFBSSxDQUFDO2FBQ3BCO1FBQ0gsQ0FBQyxFQUFBO0lBQ0gsQ0FBQzs7O1lBN05GLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsYUFBYTtnQkFDdkIseWJBQTJDOzthQUU1Qzs7Ozs7MEJBa0JFLEtBQUssU0FBQyxZQUFZOzZCQWNsQixLQUFLLFNBQUMsZUFBZTtxQkFLckIsS0FBSyxTQUFDLE9BQU87OEJBS2IsTUFBTSxTQUFDLFVBQVU7OEJBR2pCLE1BQU0sU0FBQyxVQUFVOzBCQUdqQixTQUFTLFNBQUMsVUFBVSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTs7Ozs7OztJQTlDdkMsbUNBQXVCOzs7OztJQUN2Qix1Q0FBMkI7Ozs7O0lBQzNCLDhDQUFpRTs7Ozs7SUFDakUsOENBQWlGOzs7OztJQUNqRixpREFBcUQ7Ozs7O0lBQ3JELG1EQUFtRDs7Ozs7SUFFbkQsMERBQWtEOzs7OztJQUNsRCwwREFBa0Q7Ozs7O0lBQ2xELHNEQUE4Qzs7Ozs7SUFDOUMsZ0NBQXFGOzs7OztJQUNyRiw0Q0FBMEM7Ozs7O0lBQzFDLHlDQUF1Qzs7Ozs7SUFDdkMscURBQTZDOztJQUM3Qyw0Q0FBMkI7O0lBMEIzQiw4Q0FDOEM7O0lBRTlDLDhDQUMrRTs7SUFFL0UsMENBQ3dCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIEFmdGVyVmlld0NoZWNrZWQsIFZpZXdDaGlsZCwgRWxlbWVudFJlZiwgSW5wdXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBPbkRlc3Ryb3ksIEFmdGVyVmlld0luaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVGVybWluYWwgfSBmcm9tICd4dGVybSc7XHJcbmltcG9ydCB7IEZpdEFkZG9uIH0gZnJvbSAneHRlcm0tYWRkb24tZml0JztcclxuaW1wb3J0IHsgTmdUZXJtaW5hbCB9IGZyb20gJy4vbmctdGVybWluYWwnO1xyXG5pbXBvcnQgeyBTdWJqZWN0LCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24sIGNvbWJpbmVMYXRlc3QsIE9iamVjdFVuc3Vic2NyaWJlZEVycm9yIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IERpc3BsYXlPcHRpb24gfSBmcm9tICcuL2Rpc3BsYXktb3B0aW9uJztcclxuaW1wb3J0IHsgUmVzaXplRXZlbnQgfSBmcm9tICdhbmd1bGFyLXJlc2l6YWJsZS1lbGVtZW50JztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnbmctdGVybWluYWwnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9uZy10ZXJtaW5hbC5jb21wb25lbnQuaHRtbCcsXHJcbiAgc3R5bGVVcmxzOiBbJy4vbmctdGVybWluYWwuY29tcG9uZW50LmNzcyddXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBOZ1Rlcm1pbmFsQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBBZnRlclZpZXdDaGVja2VkLCBOZ1Rlcm1pbmFsLCBPbkRlc3Ryb3kge1xyXG4gIHByaXZhdGUgdGVybTogVGVybWluYWw7XHJcbiAgcHJpdmF0ZSBmaXRBZGRvbjogRml0QWRkb247XHJcbiAgcHJpdmF0ZSBrZXlJbnB1dFN1YmplY3Q6IFN1YmplY3Q8c3RyaW5nPiA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTtcclxuICBwcml2YXRlIGtleUV2ZW50U3ViamVjdCA9IG5ldyBTdWJqZWN0PHtrZXk6IHN0cmluZzsgZG9tRXZlbnQ6IEtleWJvYXJkRXZlbnQ7fT4oKTtcclxuICBwcml2YXRlIHRlcm1TbmlwcGV0U3ViamVjdCA9IG5ldyBTdWJqZWN0PCgpPT52b2lkPigpO1xyXG4gIHByaXZhdGUgYWZ0ZXJWaWV3SW5pdFN1YmplY3QgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xyXG4gIFxyXG4gIHByaXZhdGUga2V5SW5wdXRTdWJqZWN0U3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcbiAgcHJpdmF0ZSBrZXlFdmVudFN1YmplY3RTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuICBwcml2YXRlIHRlcm1TbmlwcGV0U3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcbiAgcHJpdmF0ZSBoID0gTWF0aC5tYXgoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCwgd2luZG93LmlubmVySGVpZ2h0IHx8IDApO1xyXG4gIHByaXZhdGUgZGlzcGxheU9wdGlvbjogRGlzcGxheU9wdGlvbiA9IHt9O1xyXG4gIHByaXZhdGUgZGF0YVNvdXJjZTogT2JzZXJ2YWJsZTxzdHJpbmc+O1xyXG4gIHByaXZhdGUgZGF0YVNvdXJjZVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG4gIHRlcm1pbmFsU3R5bGU6IG9iamVjdCA9IHt9O1xyXG5cclxuICBASW5wdXQoJ2RhdGFTb3VyY2UnKVxyXG4gIHNldCBfZGF0YVNvdXJjZShkcykge1xyXG4gICAgaWYodGhpcy5kYXRhU291cmNlU3Vic2NyaXB0aW9uICE9IG51bGwpe1xyXG4gICAgICB0aGlzLmRhdGFTb3VyY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICAgIHRoaXMuZGF0YVNvdXJjZSA9IGRzO1xyXG4gICAgdGhpcy5kYXRhU291cmNlU3Vic2NyaXB0aW9uID0gdGhpcy5kYXRhU291cmNlLnN1YnNjcmliZSgoZGF0YSkgPT4ge1xyXG4gICAgICB0aGlzLndyaXRlKGRhdGEpO1xyXG4gICAgfSlcclxuICB9XHJcbiAgZ2V0IF9kYXRhU291cmNlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZGF0YVNvdXJjZTtcclxuICB9XHJcblxyXG4gIEBJbnB1dCgnZGlzcGxheU9wdGlvbicpXHJcbiAgc2V0IF9kaXNwbGF5T3B0aW9uKG9wdDogRGlzcGxheU9wdGlvbil7XHJcbiAgICB0aGlzLnNldERpc3BsYXlPcHRpb24ob3B0KTtcclxuICB9XHJcblxyXG4gIEBJbnB1dCgnc3R5bGUnKVxyXG4gIHNldCBfc3R5bGUob3B0OiBhbnkpe1xyXG4gICAgdGhpcy5zZXRTdHlsZShvcHQpO1xyXG4gIH1cclxuXHJcbiAgQE91dHB1dCgna2V5SW5wdXQnKVxyXG4gIGtleUlucHV0RW1pdHRlciAgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcclxuXHJcbiAgQE91dHB1dCgna2V5RXZlbnQnKVxyXG4gIGtleUV2ZW50RW1pdHRlciAgPSBuZXcgRXZlbnRFbWl0dGVyPHtrZXk6IHN0cmluZzsgZG9tRXZlbnQ6IEtleWJvYXJkRXZlbnQ7fT4oKTtcclxuXHJcbiAgQFZpZXdDaGlsZCgndGVybWluYWwnLCB7IHN0YXRpYzogdHJ1ZSB9KSBcclxuICB0ZXJtaW5hbERpdjogRWxlbWVudFJlZjtcclxuXHJcbiAgY29uc3RydWN0b3IoKSB7IFxyXG4gICAgdGhpcy50ZXJtU25pcHBldFN1YnNjcmlwdGlvbiA9IGNvbWJpbmVMYXRlc3QodGhpcy50ZXJtU25pcHBldFN1YmplY3QsIHRoaXMuYWZ0ZXJWaWV3SW5pdFN1YmplY3QpLnN1YnNjcmliZSgoW3NuaXBwZXRdKSA9PiB7XHJcbiAgICAgIHNuaXBwZXQoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvYnNlcnZhYmxlU2V0dXAoKXtcclxuICAgIHRoaXMudGVybS5vbkRhdGEoKGlucHV0KSA9PiB7XHJcbiAgICAgIHRoaXMua2V5SW5wdXRTdWJqZWN0Lm5leHQoaW5wdXQpO1xyXG4gICAgfSk7XHJcbiAgICB0aGlzLnRlcm0ub25LZXkoZSA9PiB7XHJcbiAgICAgIHRoaXMua2V5RXZlbnRTdWJqZWN0Lm5leHQoZSk7XHJcbiAgICB9KVxyXG4gICAgdGhpcy5rZXlJbnB1dFN1YmplY3RTdWJzY3JpcHRpb24gPSB0aGlzLmtleUlucHV0U3ViamVjdC5zdWJzY3JpYmUoKGRhdGEpID0+IHtcclxuICAgICAgdGhpcy5rZXlJbnB1dEVtaXR0ZXIuZW1pdChkYXRhKTtcclxuICAgIH0pXHJcbiAgICB0aGlzLmtleUV2ZW50U3ViamVjdFN1YnNjcmlwdGlvbiA9IHRoaXMua2V5RXZlbnRTdWJqZWN0LnN1YnNjcmliZSgoZSkgPT4ge1xyXG4gICAgICB0aGlzLmtleUV2ZW50RW1pdHRlci5lbWl0KGUpO1xyXG4gICAgfSk7XHJcbiAgICB0aGlzLmFmdGVyVmlld0luaXRTdWJqZWN0Lm5leHQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIHNldCBibG9jayBvciBpbmxpbmUtYmxvY2sgdG8gI3Rlcm1pbmFsIGZvciBmaXR0aW5nIGNsaWVudCBvciBvdXRlciBlbGVtZW50XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzZXRUZXJtaW5hbEJsb2NrKGlzQmxvY2s6IGJvb2xlYW4pe1xyXG4gICAgaWYoaXNCbG9jaylcclxuICAgICAgdGhpcy50ZXJtaW5hbFN0eWxlWydkaXNwbGF5J10gPSAnYmxvY2snO1xyXG4gICAgZWxzZVxyXG4gICAgICB0aGlzLnRlcm1pbmFsU3R5bGVbJ2Rpc3BsYXknXSA9ICdpbmxpbmUtYmxvY2snO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogc2V0IGRpbWVuc2lvbnNcclxuICAgKi9cclxuICBwcml2YXRlIHNldFRlcm1pbmFsRGltZW5zaW9ucyhsZWZ0OiBudW1iZXIsIHRvcDogbnVtYmVyLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcikge1xyXG4gICAgdGhpcy50ZXJtaW5hbFN0eWxlWydsZWZ0J10gPSBsZWZ0ID8gYCR7bGVmdH1weGAgOiB1bmRlZmluZWQ7XHJcbiAgICB0aGlzLnRlcm1pbmFsU3R5bGVbJ3RvcCddID0gdG9wID8gYCR7dG9wfXB4YCA6IHVuZGVmaW5lZDtcclxuICAgIHRoaXMudGVybWluYWxTdHlsZVsnd2lkdGgnXSA9IHdpZHRoID8gYCR7d2lkdGh9cHhgIDogdW5kZWZpbmVkO1xyXG4gICAgdGhpcy50ZXJtaW5hbFN0eWxlWydoZWlnaHQnXSA9IGhlaWdodCA/IGAke2hlaWdodH1weGAgOiB1bmRlZmluZWQ7XHJcbiAgfVxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIHJlbW92ZSBkaW1lbnNpb25zXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZW1vdmVUZXJtaW5hbERpbWVuc2lvbnMoKXtcclxuICAgIHRoaXMudGVybWluYWxTdHlsZVsnbGVmdCddID0gdW5kZWZpbmVkO1xyXG4gICAgdGhpcy50ZXJtaW5hbFN0eWxlWyd0b3AnXSA9IHVuZGVmaW5lZDtcclxuICAgIHRoaXMudGVybWluYWxTdHlsZVsnd2lkdGgnXSA9IHVuZGVmaW5lZDtcclxuICAgIHRoaXMudGVybWluYWxTdHlsZVsnaGVpZ2h0J10gPSB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICBzZXRTdHlsZShzdHlsZU9iamVjdDogYW55KXtcclxuICAgIE9iamVjdC5hc3NpZ24odGhpcy50ZXJtaW5hbFN0eWxlLCBzdHlsZU9iamVjdCk7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpe1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogV2hlbiBhIGRpbWVuc2lvbiBvZiBkaXYgY2hhbmdlcywgZml0IGEgdGVybWluYWwgaW4gZGl2LlxyXG4gICAqL1xyXG4gIG5nQWZ0ZXJWaWV3Q2hlY2tlZCgpIHtcclxuICAgIGxldCBkaW1zID0gdGhpcy5maXRBZGRvbi5wcm9wb3NlRGltZW5zaW9ucygpO1xyXG4gICAgaWYoZGltcyA9PT0gdW5kZWZpbmVkIHx8IGlzTmFOKGRpbXMucm93cykgfHwgZGltcy5yb3dzID09IEluZmluaXR5IHx8IGlzTmFOKGRpbXMuY29scykgfHwgZGltcy5jb2xzID09IEluZmluaXR5KXtcclxuICAgICAgdGhpcy50ZXJtLnJlc2l6ZSgxMCwgMTApO1xyXG4gICAgfWVsc2UgaWYoIXRoaXMuZGlzcGxheU9wdGlvbi5maXhlZEdyaWQpe1xyXG4gICAgICB0aGlzLmZpdEFkZG9uLmZpdCgpO1xyXG4gICAgfWVsc2V7XHJcbiAgICAgIHRoaXMudGVybS5yZXNpemUodGhpcy5kaXNwbGF5T3B0aW9uLmZpeGVkR3JpZC5jb2xzLCB0aGlzLmRpc3BsYXlPcHRpb24uZml4ZWRHcmlkLnJvd3MpO1xyXG4gICAgICBsZXQgeHRlcm1TY3JlZW4gPSB0aGlzLnRlcm0uZWxlbWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCd4dGVybS1zY3JlZW4nKVswXTtcclxuICAgICAgbGV0IHNjcm9sbEFyZWEgPSB0aGlzLnRlcm0uZWxlbWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCd4dGVybS1zY3JvbGwtYXJlYScpWzBdO1xyXG4gICAgICBsZXQgdGVybWluYWwgPSB0aGlzLnRlcm0uZWxlbWVudDtcclxuICAgICAgY29uc3QgY29udGVudFdpZHRoID0geHRlcm1TY3JlZW4uY2xpZW50V2lkdGg7XHJcbiAgICAgIGNvbnN0IHNjcm9sbFdpZHRoID0gdGVybWluYWwuY2xpZW50V2lkdGggLSBzY3JvbGxBcmVhLmNsaWVudFdpZHRoO1xyXG4gICAgICB0aGlzLnNldFRlcm1pbmFsRGltZW5zaW9ucyh1bmRlZmluZWQsIHVuZGVmaW5lZCwgY29udGVudFdpZHRoICsgc2Nyb2xsV2lkdGgsIHVuZGVmaW5lZCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBJdCBjcmVhdGVzIG5ldyB0ZXJtaW5hbCBpbiAjdGVybWluYWwuXHJcbiAgICovXHJcbiAgbmdBZnRlclZpZXdJbml0KCkge1xyXG4gICAgdGhpcy5maXRBZGRvbiA9IG5ldyBGaXRBZGRvbigpO1xyXG4gICAgdGhpcy50ZXJtID0gbmV3IFRlcm1pbmFsKCk7XHJcbiAgICB0aGlzLnRlcm0ub3Blbih0aGlzLnRlcm1pbmFsRGl2Lm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgdGhpcy50ZXJtLmxvYWRBZGRvbih0aGlzLmZpdEFkZG9uKTtcclxuICAgIHRoaXMub2JzZXJ2YWJsZVNldHVwKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBjbGVhbiBhbGwgcmVzb3VyY2VzXHJcbiAgICovXHJcbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICBpZih0aGlzLmtleUlucHV0U3ViamVjdFN1YnNjcmlwdGlvbilcclxuICAgICAgdGhpcy5rZXlJbnB1dFN1YmplY3RTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgIGlmKHRoaXMuZGF0YVNvdXJjZVN1YnNjcmlwdGlvbilcclxuICAgICAgdGhpcy5kYXRhU291cmNlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICBpZih0aGlzLmtleUV2ZW50U3ViamVjdFN1YnNjcmlwdGlvbilcclxuICAgICAgdGhpcy5rZXlFdmVudFN1YmplY3RTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgIGlmKHRoaXMudGVybVNuaXBwZXRTdWJzY3JpcHRpb24pXHJcbiAgICB0aGlzLnRlcm1TbmlwcGV0U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICBpZih0aGlzLnRlcm0pXHJcbiAgICAgIHRoaXMudGVybS5kaXNwb3NlKCk7XHJcbiAgfVxyXG5cclxuICB3cml0ZShjaGFyczogc3RyaW5nKSB7XHJcbiAgICB0aGlzLnRlcm0ud3JpdGUoY2hhcnMpO1xyXG4gIH1cclxuXHJcbiAgc2V0RGlzcGxheU9wdGlvbihvcHQ6IERpc3BsYXlPcHRpb24pIHtcclxuICAgIGlmIChvcHQpIHtcclxuICAgICAgaWYgKG9wdC5maXhlZEdyaWQgIT0gbnVsbCkge1xyXG4gICAgICAgIGNvbnNvbGUuZGVidWcoXCJyZXNpemFibGUgd2lsbCBiZSBpZ25vcmVkLlwiKTtcclxuICAgICAgICB0aGlzLnNldFRlcm1pbmFsQmxvY2soZmFsc2UpO1xyXG4gICAgICAgIHRoaXMucmVtb3ZlVGVybWluYWxEaW1lbnNpb25zKCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5zZXRUZXJtaW5hbEJsb2NrKHRydWUpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuZGlzcGxheU9wdGlvbiA9IG9wdDtcclxuICAgIH0gZWxzZVxyXG4gICAgICBjb25zb2xlLndhcm4oYEEgZmFsc3kgb3B0aW9uIGlzIG5vdCBhbGxvd2VkYCk7XHJcbiAgfVxyXG5cclxuICBnZXQga2V5SW5wdXQoKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcclxuICAgIHJldHVybiB0aGlzLmtleUlucHV0U3ViamVjdDtcclxuICB9XHJcblxyXG4gIGdldCBrZXlFdmVudElucHV0KCk6IE9ic2VydmFibGU8e2tleTogc3RyaW5nOyBkb21FdmVudDogS2V5Ym9hcmRFdmVudDt9PiB7XHJcbiAgICByZXR1cm4gdGhpcy5rZXlFdmVudFN1YmplY3Q7XHJcbiAgfVxyXG5cclxuICBnZXQgdW5kZXJseWluZygpOiBUZXJtaW5hbCB7XHJcbiAgICByZXR1cm4gdGhpcy50ZXJtO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGlzRHJhZ2dhYmxlT25FZGdlQWN0aXZhdGVkKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZGlzcGxheU9wdGlvbi5hY3RpdmF0ZURyYWdnYWJsZU9uRWRnZSAhPSB1bmRlZmluZWQgJiYgdGhpcy5kaXNwbGF5T3B0aW9uLmZpeGVkR3JpZCA9PSB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBZnRlciB1c2VyIGNvb3JkaW5hdGUgZGltZW5zaW9ucyBvZiB0ZXJtaW5hbCwgaXQncyBjYWxsZWQuXHJcbiAgICogQHBhcmFtIGxlZnQgXHJcbiAgICogQHBhcmFtIHRvcCBcclxuICAgKiBAcGFyYW0gd2lkdGggXHJcbiAgICogQHBhcmFtIGhlaWdodCBcclxuICAgKi9cclxuICBvblJlc2l6ZUVuZChsZWZ0OiBudW1iZXIsIHRvcDogbnVtYmVyLCB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcik6IHZvaWQge1xyXG4gICAgdGhpcy5zZXRUZXJtaW5hbERpbWVuc2lvbnMobGVmdCwgdG9wLCB3aWR0aCwgaGVpZ2h0KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEJlZm9yZSBvblJlc2l6ZUVuZCBpcyBjYWxsZWQsIGl0IHZhbGlhdGVzIGRpbWVuc2lvbnMgdG8gY2hhbmdlLlxyXG4gICAqIEBwYXJhbSByZSBkaW1lbnNpb24gdG8gYmUgc3VibWl0dGVkIGZyb20gcmVzaXphYmxlIHN0dWZmXHJcbiAgICovXHJcbiAgdmFsaWRhdG9yRmFjdG9yeSgpOiAocmU6IFJlc2l6ZUV2ZW50KSA9PiBib29sZWFuIHtcclxuICAgIGNvbnN0IGNvbXAgPSB0aGlzO1xyXG4gICAgcmV0dXJuIChyZTogUmVzaXplRXZlbnQpID0+eyBcclxuICAgICAgY29uc3QgZGlzcGxheU9wdGlvbiA9IGNvbXAuZGlzcGxheU9wdGlvbjtcclxuICAgICAgaWYoZGlzcGxheU9wdGlvbi5hY3RpdmF0ZURyYWdnYWJsZU9uRWRnZSl7XHJcbiAgICAgICAgbGV0IGxlZnQgPSByZS5yZWN0YW5nbGUubGVmdCwgdG9wID0gcmUucmVjdGFuZ2xlLnRvcCwgd2lkdGggPSByZS5yZWN0YW5nbGUud2lkdGgsIGhlaWdodCA9IHJlLnJlY3RhbmdsZS5oZWlnaHQ7XHJcbiAgICAgICAgaWYgKCh3aWR0aCA8IGRpc3BsYXlPcHRpb24uYWN0aXZhdGVEcmFnZ2FibGVPbkVkZ2UubWluV2lkdGgpIHx8IChoZWlnaHQgPCBkaXNwbGF5T3B0aW9uLmFjdGl2YXRlRHJhZ2dhYmxlT25FZGdlLm1pbkhlaWdodCkpIHtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9IGVsc2UgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19